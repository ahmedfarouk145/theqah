/* TheQah Widget - https://theqah.com */
(()=>{if(window.__THEQAH_LOADING__)return;window.__THEQAH_LOADING__=!0;const e=document.currentScript,t=(()=>{try{return new URL(e?.src||location.href).origin}catch{return location.origin}})(),o=`${t}/api/public/reviews`,r=`${t}/api/reviews/check-verified`,n=`${t}/widgets/logo.png?v=3`,i=`${t}/widgets/logo.png?v=3`,a=(e,t={},o=[])=>{const r=document.createElement(e);for(const[e,o]of Object.entries(t||{}))"class"===e?r.className=o:"html"===e?r.innerHTML=o:r.setAttribute(e,o);return(Array.isArray(o)?o:[o]).filter(Boolean).forEach(e=>"string"==typeof e?r.appendChild(document.createTextNode(e)):r.appendChild(e)),r},s=window.__THEQAH__=window.__THEQAH__||{};function c(e){return`theqah:storeUid:${e}`}async function d(){const e=location.host.replace(/^www\./,"").toLowerCase();if(s.storeData)return s.storeData;const t=function(e){try{const t=JSON.parse(localStorage.getItem(c(e))||"{}");if(t.uid&&Date.now()-(t.t||0)<6e5)return t.uid}catch{}return null}(e);if(t)return s.storeData="string"==typeof t?{storeUid:t,certificatePosition:"auto"}:t,s.storeData;if(s.resolvePromise)return s.resolvePromise;const r=new AbortController,n=setTimeout(()=>r.abort(),5e3),i=`${o}/resolve?host=${encodeURIComponent(e)}&href=${encodeURIComponent(location.href)}&v=${encodeURIComponent("3.0.0")}`;return s.resolvePromise=fetch(i,{cache:"no-store",signal:r.signal}).then(e=>(clearTimeout(n),e.ok?e.json():null)).then(t=>{if(!t?.storeUid)return null;const o={storeUid:t.storeUid,certificatePosition:t.certificatePosition||"auto"};return s.storeData=o,function(e,t){try{localStorage.setItem(c(e),JSON.stringify({uid:t,t:Date.now()}))}catch{}}(e,o),o}).catch(e=>(clearTimeout(n),console.warn("Store resolve failed:",e.message),null)).finally(()=>{s.resolvePromise=null}),s.resolvePromise}async function l(e,t,o,s,c="auto"){if("done"===e.getAttribute("data-state"))return;if("mounting"===e.getAttribute("data-state"))return;e.setAttribute("data-state","mounting");const d=function(){const e=document.querySelector("[data-product-id], [data-productid]");if(e){const t=e.getAttribute("data-product-id")||e.getAttribute("data-productid");if(t)return t}const t=location.pathname.match(/\/product\/(\d+)/);if(t)return t[1];const o=new URLSearchParams(location.search);return o.get("product_id")||o.get("productId")||null}(),l=await async function(e,t){try{const o=new URLSearchParams({storeId:e});t&&o.append("productId",t);const n=await fetch(`${r}?${o}`,{cache:"no-store",signal:AbortSignal.timeout(5e3)});return n.ok?await n.json():{hasVerified:!1,reviews:[]}}catch(e){return console.warn("Check verified failed:",e.message),{hasVerified:!1,reviews:[]}}}(t,d);if(function(e,t,o,r="auto"){if(document.querySelector(".theqah-certificate-badge"))return;const n=function(e="ar",t="light"){if(document.querySelector(".theqah-certificate-badge"))return null;const o="ar"===e,r="dark"===t,n=o?"شهادة توثيق التقييمات":"Verified Reviews Certificate",s=o?'جميع تقييمات هذا المتجر مدققة من مشتري موثق "طرف ثالث" لضمان المصداقية':"All store reviews are audited by Mushtari Mowthaq (Third Party) to ensure credibility",c=a("div",{class:"theqah-certificate-badge",style:`\n        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica Neue, Noto Sans, Arial, sans-serif;\n        direction: ${o?"rtl":"ltr"};\n        text-align: center;\n        background: ${r?"linear-gradient(135deg, #0f1629 0%, #1e293b 100%)":"linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%)"};\n        border: 2px solid ${r?"rgba(34, 197, 94, 0.3)":"rgba(34, 197, 94, 0.4)"};\n        border-radius: 16px;\n        padding: 24px;\n        margin: 20px auto;\n        max-width: 500px;\n        box-shadow: ${r?"0 10px 25px -5px rgba(0, 0, 0, 0.4)":"0 10px 25px -5px rgba(34, 197, 94, 0.15)"};\n        position: relative;\n        overflow: hidden;\n      `});c.innerHTML='\n      <div style="\n        position: absolute;\n        top: 0;\n        left: 0;\n        right: 0;\n        height: 4px;\n        background: linear-gradient(90deg, #22c55e, #16a34a, #22c55e);\n      "></div>\n    ';const d=a("a",{href:"https://theqah.com.sa?ref=certificate",target:"_blank",rel:"noopener noreferrer",style:"\n        display: inline-block;\n        margin-bottom: 16px;\n        transition: transform 0.2s ease;\n      "}),l=a("img",{src:i,alt:o?"مشتري موثق":"Mushtari Mowthaq",style:"\n        width: 72px;\n        height: 72px;\n        border-radius: 12px;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n      "});d.appendChild(l),d.onmouseover=function(){this.style.transform="scale(1.05)"},d.onmouseout=function(){this.style.transform="scale(1)"};const u=a("h3",{style:`\n        font-size: 20px;\n        font-weight: 700;\n        color: ${r?"#22c55e":"#15803d"};\n        margin: 0 0 12px 0;\n        line-height: 1.4;\n      `},n),m=a("p",{style:`\n        font-size: 14px;\n        color: ${r?"#94a3b8":"#64748b"};\n        margin: 0;\n        line-height: 1.6;\n        max-width: 400px;\n        margin-left: auto;\n        margin-right: auto;\n      `},s);return c.appendChild(d),c.appendChild(u),c.appendChild(m),c}(t,o);if(!n)return;const s=function(e){if("before-reviews"===e){const e=document.querySelector("salla-products-comments, .s-comments-list, .product-reviews, #reviews, [data-reviews]");if(e)return{element:e,position:"before"}}if("after-reviews"===e){const e=document.querySelector("salla-products-comments, .s-comments-list, .product-reviews, #reviews, [data-reviews]");if(e)return{element:e,position:"after"}}if("footer"===e){const e=document.querySelector("footer, .s-footer, .store-footer");if(e)return{element:e,position:"before"}}if("floating"===e)return{type:"floating"};const t=document.querySelector("salla-products-comments, .s-comments-list, .product-reviews, .reviews-section, #reviews, [data-reviews]");if(t)return{element:t,position:"before"};const o=document.querySelector(".product-description, .product__description, .s-product-description, [data-product-description]");if(o)return{element:o,position:"after"};const r=document.querySelector(".product-info, .product__info, .s-product-info, .product-details");if(r)return{element:r,position:"after"};const n=document.querySelector("footer, .s-footer");return n?{element:n,position:"before"}:{type:"floating"}}(r);s?"floating"===s.type?(n.style.cssText+="\n        position: fixed;\n        bottom: 20px;\n        right: 20px;\n        z-index: 9999;\n        max-width: 320px;\n        animation: theqah-slide-in 0.3s ease-out;\n      ",document.body.appendChild(n),console.log("[Theqah] Certificate badge inserted as floating")):s.element&&("before"===s.position?s.element.parentNode.insertBefore(n,s.element):s.element.parentNode.insertBefore(n,s.element.nextSibling),console.log("[Theqah] Certificate badge inserted:",s.position,"reviews")):console.log("[Theqah] No suitable placement found for certificate")}(0,o,s,c),console.log("[Theqah] Certificate badge inserted for store:",t),l.hasVerified){const e=l.reviews.map(e=>e.sallaReviewId);!function(e){if(!e||0===e.length)return;const t=e.map(e=>String(e));console.log("[Theqah] Looking for reviews with IDs:",t),["salla-comment-item",".s-comments-item",'[id^="s-comments-item-"]',"[data-review-id]","[data-comment-id]",".product-review",".review-item",".s-review-item",".comment-item",'[class*="comment"]','[class*="review"]'].forEach(e=>{const o=document.querySelectorAll(e);o.length>0&&console.log(`[Theqah] Found ${o.length} elements with selector: ${e}`),o.forEach(o=>{let r=null;if(r=o.getAttribute("data-review-id")||o.getAttribute("data-id")||o.getAttribute("data-comment-id"),!r){const e=o.querySelector('[id^="s-comments-item-"]');if(e){const t=e.id.match(/s-comments-item-(\d+)/);t&&(r=t[1])}}if(!r&&o.id){const e=o.id.match(/s-comments-item-(\d+)/)||o.id.match(/comment-(\d+)/)||o.id.match(/review-(\d+)/);e&&(r=e[1])}if(r||(r=o.querySelector("[data-review-id]")?.getAttribute("data-review-id")||o.querySelector("[data-comment-id]")?.getAttribute("data-comment-id")),!r){const e=o.attributes;for(let t=0;t<e.length;t++){const o=e[t].value.match(/(\d{5,})/);if(o){r=o[1];break}}}if(!r&&o.shadowRoot){const e=o.shadowRoot.querySelector('[id^="s-comments-item-"]');if(e){const t=e.id.match(/s-comments-item-(\d+)/);t&&(r=t[1])}}if(r||"salla-comment-item"!==e||console.log("[Theqah] DEBUG: salla-comment-item found but no ID extracted:",{tagName:o.tagName,id:o.id,className:o.className,attributes:Array.from(o.attributes).map(e=>`${e.name}="${e.value}"`).join(", "),innerHTML:o.innerHTML?.substring(0,200),hasShadowRoot:!!o.shadowRoot}),r&&console.log(`[Theqah] Found review element with ID: ${r}, matches: ${t.includes(String(r))}`),!r||!t.includes(String(r)))return;if(o.querySelector(".theqah-verified-logo"))return;let i=o.querySelector(".s-comments-item-user-info-name")||o.querySelector(".s-comments-item-user-wrapper")||o.querySelector('[class*="user-name"]')||o.querySelector('[class*="user-info"]')||o.querySelector('[class*="author"]')||o.querySelector(".review-header")||o.querySelector(".review-stars")||o.querySelector(".review-rating")||o.querySelector('[class*="rating"]')||o.firstElementChild;if(!i)return void console.log("[Theqah] No insert point found for review:",r);console.log("[Theqah] Adding logo to review:",r,"at:",i.className||i.tagName);const a=document.createElement("a");a.href="https://theqah.com.sa?ref=widget",a.target="_blank",a.rel="noopener noreferrer",a.title="مشتري موثق - Verified Buyer | theqah.com.sa",a.style.cssText="display:inline-flex;align-items:center;text-decoration:none;transition:transform 0.2s ease;margin-inline-start:8px;",a.onmouseover=function(){this.style.transform="scale(1.1)"},a.onmouseout=function(){this.style.transform="scale(1)"};const s=document.createElement("img");s.src=n,s.className="theqah-verified-logo",s.alt="مشتري موثق - Verified Buyer",s.style.cssText="width:60px;height:60px;margin:0 8px;display:inline-block;vertical-align:middle;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.15);cursor:pointer;",a.appendChild(s),i.style.display="flex",i.style.alignItems="center",i.style.gap="8px",i.appendChild(a),console.log("[Theqah] Added verified badge to review:",r)})})}(e),console.log("[Theqah] Added logos to verified reviews:",e.length)}e.setAttribute("data-state","done")}const u=async()=>{const t=document.querySelector("#theqah-reviews, .theqah-reviews");let o=t?.getAttribute?.("data-store")||t?.dataset?.store||e?.dataset?.store||"";const r=t?.getAttribute?.("data-lang")||t?.dataset?.lang||e?.dataset?.lang||("ar"===document.documentElement.lang?"ar":"en"),n=t?.getAttribute?.("data-theme")||t?.dataset?.theme||e?.dataset?.theme||"light";o&&(o.includes("{")||/STORE_ID/i.test(o)||"salla:"===o||!o.includes(":"))&&(console.log("[Theqah] Detected placeholder store:",o,"- attempting auto-resolve"),o="");let i=null,a="auto";if(!o)try{const e=new Promise((e,t)=>setTimeout(()=>t(new Error("Resolve timeout")),5e3));i=await Promise.race([d(),e]),i&&(o=i.storeUid,a=i.certificatePosition||"auto",console.log("[Theqah] Store resolved:",o,"position:",a))}catch(e){console.warn("[Theqah] Store resolution failed:",e.message),o=null}const s=t||function(){let e=document.querySelector("#theqah-reviews, .theqah-reviews");if(e)return e;const t=function(){const e=document.querySelector("[data-product-id], [data-productid]");if(e){const t=e.closest("section, .product, .product-page, .product__details, .product-single, .product-show");if(t)return t}const t=[".product-description",".product__description","#product-description",".product__details",".product-show",".product-single",".product-details",".product-info",".product-main","#product-show","#product","main .container"];for(const e of t){const t=document.querySelector(e);if(t)return t}return null}();return t?(e=document.createElement("div"),e.className="theqah-reviews",e.style.marginTop="24px",t&&t.parentNode&&t.parentNode.insertBefore(e,t.nextSibling),e):null}();s&&o&&(await l(s,o,String(r).toLowerCase(),String(n).toLowerCase(),a),mountedOnce=!0)},m=()=>{try{u().catch(e=>console.warn("Widget mount failed:",e.message))}catch(e){console.warn("Widget initialization failed:",e.message)}finally{window.__THEQAH_LOADING__=!1}};if("loading"===document.readyState?document.addEventListener("DOMContentLoaded",m):setTimeout(m,100),!window.__THEQAH_OBS__&&"undefined"!=typeof MutationObserver){window.__THEQAH_OBS__=!0;const e=function(e){let t;return function(...o){clearTimeout(t),t=setTimeout(()=>e.apply(this,o),1e3)}}(()=>u()),t=new MutationObserver(t=>{t.some(e=>Array.from(e.addedNodes).some(e=>1===e.nodeType&&(e.classList?.contains("theqah-reviews")||e.querySelector?.(".theqah-reviews"))))&&e()});try{t.observe(document.body,{childList:!0,subtree:!0,attributes:!1,characterData:!1}),setTimeout(()=>{t.disconnect(),window.__THEQAH_OBS__=!1},3e4)}catch(e){console.warn("MutationObserver failed:",e)}}})();