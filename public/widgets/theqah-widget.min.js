/* TheQah Widget - https://theqah.com */
(()=>{if(window.__THEQAH_LOADING__)return;window.__THEQAH_LOADING__=!0;const e=document.currentScript,t=(()=>{try{return new URL(e?.src||location.href).origin}catch{return location.origin}})(),r=`${t}/api/public/reviews`,o=`${t}/api/reviews/check-verified`,n=`${t}/widgets/logo.png?v=3`,i=window.__THEQAH__=window.__THEQAH__||{};function a(e){return`theqah:storeUid:${e}`}async function s(){const e=location.host.replace(/^www\./,"").toLowerCase();if(i.storeUid)return i.storeUid;const t=function(e){try{const t=JSON.parse(localStorage.getItem(a(e))||"{}");if(t.uid&&Date.now()-(t.t||0)<6e5)return t.uid}catch{}return null}(e);if(t)return i.storeUid=t,t;if(i.resolvePromise)return i.resolvePromise;const o=new AbortController,n=setTimeout(()=>o.abort(),5e3),s=`${r}/resolve?host=${encodeURIComponent(e)}&href=${encodeURIComponent(location.href)}&v=${encodeURIComponent("3.0.0")}`;return i.resolvePromise=fetch(s,{cache:"no-store",signal:o.signal}).then(e=>(clearTimeout(n),e.ok?e.json():null)).then(t=>{const r=t?.storeUid||null;return r&&(i.storeUid=r,function(e,t){try{localStorage.setItem(a(e),JSON.stringify({uid:t,t:Date.now()}))}catch{}}(e,r)),r}).catch(e=>(clearTimeout(n),console.warn("Store resolve failed:",e.message),null)).finally(()=>{i.resolvePromise=null}),i.resolvePromise}const c=async()=>{const t=document.querySelector("#theqah-reviews, .theqah-reviews");let r=t?.getAttribute?.("data-store")||t?.dataset?.store||e?.dataset?.store||"";const i=t?.getAttribute?.("data-lang")||t?.dataset?.lang||e?.dataset?.lang||("ar"===document.documentElement.lang?"ar":"en"),a=t?.getAttribute?.("data-theme")||t?.dataset?.theme||e?.dataset?.theme||"light";if(r&&(r.includes("{")||/STORE_ID/i.test(r)||"salla:"===r||!r.includes(":"))&&(r=""),!r)try{const e=new Promise((e,t)=>setTimeout(()=>t(new Error("Resolve timeout")),5e3));r=await Promise.race([s(),e])}catch(e){r=null}const c=t||function(){let e=document.querySelector("#theqah-reviews, .theqah-reviews");if(e)return e;const t=function(){const e=document.querySelector("[data-product-id], [data-productid]");if(e){const t=e.closest("section, .product, .product-page, .product__details, .product-single, .product-show");if(t)return t}const t=[".product-description",".product__description","#product-description",".product__details",".product-show",".product-single",".product-details",".product-info",".product-main","#product-show","#product","main .container"];for(const e of t){const t=document.querySelector(e);if(t)return t}return null}();return t?(e=document.createElement("div"),e.className="theqah-reviews",e.style.marginTop="24px",t&&t.parentNode&&t.parentNode.insertBefore(e,t.nextSibling),e):null}();c&&r&&(await async function(e,t){if("done"===e.getAttribute("data-state"))return;if("mounting"===e.getAttribute("data-state"))return;e.setAttribute("data-state","mounting");const r=function(){const e=document.querySelector("[data-product-id], [data-productid]");if(e){const t=e.getAttribute("data-product-id")||e.getAttribute("data-productid");if(t)return t}const t=location.pathname.match(/\/product\/(\d+)/);if(t)return t[1];const r=new URLSearchParams(location.search);return r.get("product_id")||r.get("productId")||null}(),i=await async function(e,t){try{const r=new URLSearchParams({storeId:e});t&&r.append("productId",t);const n=await fetch(`${o}?${r}`,{cache:"no-store",signal:AbortSignal.timeout(5e3)});return n.ok?await n.json():{hasVerified:!1,reviews:[]}}catch(e){return console.warn("Check verified failed:",e.message),{hasVerified:!1,reviews:[]}}}(t,r);if(i.hasVerified)return(a=i.reviews.map(e=>e.sallaReviewId))&&0!==a.length&&["[data-review-id]",".product-review",".review-item",".s-review-item"].forEach(e=>{document.querySelectorAll(e).forEach(e=>{const t=e.getAttribute("data-review-id")||e.getAttribute("data-id")||e.querySelector("[data-review-id]")?.getAttribute("data-review-id");if(!t||!a.includes(t))return;if(e.querySelector(".theqah-verified-logo"))return;let r=e.querySelector(".review-header")||e.querySelector(".review-stars")||e.querySelector(".review-rating")||e.firstElementChild;if(!r)return;const o=document.createElement("img");o.src=n,o.className="theqah-verified-logo",o.alt="Verified by Theqah",o.style.cssText="width:24px;height:24px;margin:0 8px;display:inline-block;vertical-align:middle;border-radius:4px;",r.style.display="flex",r.style.alignItems="center",r.style.gap="8px",r.appendChild(o)})}),void e.setAttribute("data-state","done");var a;e.setAttribute("data-state","done"),e.style.display="none"}(c,r,String(i).toLowerCase(),String(a).toLowerCase()),mountedOnce=!0)},d=()=>{try{c().catch(e=>console.warn("Widget mount failed:",e.message))}catch(e){console.warn("Widget initialization failed:",e.message)}finally{window.__THEQAH_LOADING__=!1}};if("loading"===document.readyState?document.addEventListener("DOMContentLoaded",d):setTimeout(d,100),!window.__THEQAH_OBS__&&"undefined"!=typeof MutationObserver){window.__THEQAH_OBS__=!0;const e=function(e){let t;return function(...r){clearTimeout(t),t=setTimeout(()=>e.apply(this,r),1e3)}}(()=>c()),t=new MutationObserver(t=>{t.some(e=>Array.from(e.addedNodes).some(e=>1===e.nodeType&&(e.classList?.contains("theqah-reviews")||e.querySelector?.(".theqah-reviews"))))&&e()});try{t.observe(document.body,{childList:!0,subtree:!0,attributes:!1,characterData:!1}),setTimeout(()=>{t.disconnect(),window.__THEQAH_OBS__=!1},3e4)}catch(e){console.warn("MutationObserver failed:",e)}}})();