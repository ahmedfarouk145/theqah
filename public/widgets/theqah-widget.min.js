/* TheQah Widget - https://theqah.com */
(()=>{if(window.__THEQAH_LOADING__)return;window.__THEQAH_LOADING__=!0;const e=document.currentScript,t=(()=>{try{return new URL(e?.src||location.href).origin}catch{return location.origin}})(),n=`${t}/api/public/reviews`,r=`${t}/api/reviews/check-verified`,o=`${t}/widgets/logo.png?v=3`,a=(e,t={},n=[])=>{const r=document.createElement(e);for(const[e,n]of Object.entries(t||{}))"class"===e?r.className=n:"html"===e?r.innerHTML=n:r.setAttribute(e,n);return(Array.isArray(n)?n:[n]).filter(Boolean).forEach(e=>"string"==typeof e?r.appendChild(document.createTextNode(e)):r.appendChild(e)),r},i=window.__THEQAH__=window.__THEQAH__||{};function s(e){return`theqah:storeUid:${e}`}async function d(){const e=location.host.replace(/^www\./,"").toLowerCase();if(i.storeUid)return i.storeUid;const t=function(e){try{const t=JSON.parse(localStorage.getItem(s(e))||"{}");if(t.uid&&Date.now()-(t.t||0)<6e5)return t.uid}catch{}return null}(e);if(t)return i.storeUid=t,t;if(i.resolvePromise)return i.resolvePromise;const r=new AbortController,o=setTimeout(()=>r.abort(),5e3),a=`${n}/resolve?host=${encodeURIComponent(e)}&href=${encodeURIComponent(location.href)}&v=${encodeURIComponent("3.0.0")}`;return i.resolvePromise=fetch(a,{cache:"no-store",signal:r.signal}).then(e=>(clearTimeout(o),e.ok?e.json():null)).then(t=>{const n=t?.storeUid||null;return n&&(i.storeUid=n,function(e,t){try{localStorage.setItem(s(e),JSON.stringify({uid:t,t:Date.now()}))}catch{}}(e,n)),n}).catch(e=>(clearTimeout(o),console.warn("Store resolve failed:",e.message),null)).finally(()=>{i.resolvePromise=null}),i.resolvePromise}const c=async()=>{const t=document.querySelector("#theqah-reviews, .theqah-reviews");let n=t?.getAttribute?.("data-store")||t?.dataset?.store||e?.dataset?.store||"";const i=t?.getAttribute?.("data-lang")||t?.dataset?.lang||e?.dataset?.lang||("ar"===document.documentElement.lang?"ar":"en"),s=t?.getAttribute?.("data-theme")||t?.dataset?.theme||e?.dataset?.theme||"light";if(n&&(n.includes("{")||/STORE_ID/i.test(n))&&(console.warn("Clearing placeholder store:",n),n=""),!n)try{const e=new Promise((e,t)=>setTimeout(()=>t(new Error("Resolve timeout")),5e3));n=await Promise.race([d(),e])}catch(e){console.warn("Store auto-resolution failed:",e.message),n=null}const c=t||function(){let e=document.querySelector("#theqah-reviews, .theqah-reviews");if(e)return e;const t=function(){const e=document.querySelector("[data-product-id], [data-productid]");if(e){const t=e.closest("section, .product, .product-page, .product__details, .product-single, .product-show");if(t)return t}const t=[".product-description",".product__description","#product-description",".product__details",".product-show",".product-single",".product-details",".product-info",".product-main","#product-show","#product","main .container"];for(const e of t){const t=document.querySelector(e);if(t)return t}return null}();return t?(e=document.createElement("div"),e.className="theqah-reviews",e.style.marginTop="24px",t&&t.parentNode&&t.parentNode.insertBefore(e,t.nextSibling),e):null}();if(c){if(n)await async function(e,t,n,i){if("done"===e.getAttribute("data-state"))return;if("mounting"===e.getAttribute("data-state"))return;e.setAttribute("data-state","mounting");const s=function(){const e=document.querySelector("[data-product-id], [data-productid]");if(e){const t=e.getAttribute("data-product-id")||e.getAttribute("data-productid");if(t)return t}const t=location.pathname.match(/\/product\/(\d+)/);if(t)return t[1];const n=new URLSearchParams(location.search);return n.get("product_id")||n.get("productId")||null}(),d=await async function(e,t){try{const n=new URLSearchParams({storeId:e});t&&n.append("productId",t);const o=await fetch(`${r}?${n}`,{cache:"no-store",signal:AbortSignal.timeout(5e3)});return o.ok?await o.json():{hasVerified:!1,reviews:[]}}catch(e){return console.warn("Check verified failed:",e.message),{hasVerified:!1,reviews:[]}}}(t,s);if(d.hasVerified)return(c=d.reviews.map(e=>e.sallaReviewId))&&0!==c.length&&["[data-review-id]",".product-review",".review-item",".s-review-item"].forEach(e=>{document.querySelectorAll(e).forEach(e=>{const t=e.getAttribute("data-review-id")||e.getAttribute("data-id")||e.querySelector("[data-review-id]")?.getAttribute("data-review-id");if(!t||!c.includes(t))return;if(e.querySelector(".theqah-verified-logo"))return;let n=e.querySelector(".review-header")||e.querySelector(".review-stars")||e.querySelector(".review-rating")||e.firstElementChild;if(!n)return;const r=document.createElement("img");r.src=o,r.className="theqah-verified-logo",r.alt="Verified by Theqah",r.style.cssText="width:24px;height:24px;margin:0 8px;display:inline-block;vertical-align:middle;border-radius:4px;",n.style.display="flex",n.style.alignItems="center",n.style.gap="8px",n.appendChild(r)})}),void e.setAttribute("data-state","done");var c;const l=e.attachShadow?e.attachShadow({mode:"open"}):e,u=a("style",{html:`\n        :host { all: initial; }\n        * { box-sizing: border-box; }\n        \n        .wrap { \n          font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Noto Sans,Liberation Sans,Arial,sans-serif; \n          direction: ${"ar"===n?"rtl":"ltr"}; \n          line-height: 1.5;\n          color: ${"dark"===i?"#f1f5f9":"#1e293b"};\n        }\n        \n        .section { \n          background: ${"dark"===i?"linear-gradient(135deg, #0f1629 0%, #1e293b 100%)":"linear-gradient(135deg, #ffffff 0%, #f8fafc 100%)"};\n          color: ${"dark"===i?"#f1f5f9":"#1e293b"};\n          border: 1px solid ${"dark"===i?"rgba(71, 85, 105, 0.3)":"rgba(226, 232, 240, 0.8)"};\n          border-radius: 16px; \n          padding: 20px 24px; \n          margin: 20px 0; \n          box-shadow: ${"dark"===i?"0 10px 25px -5px rgba(0, 0, 0, 0.4)":"0 10px 25px -5px rgba(0, 0, 0, 0.1)"};\n          backdrop-filter: blur(12px);\n          position: relative;\n          overflow: hidden;\n        }\n        \n        .section::before {\n          content: '';\n          position: absolute;\n          top: 0;\n          left: 0;\n          right: 0;\n          height: 1px;\n          background: linear-gradient(90deg, \n            transparent 0%, \n            ${"dark"===i?"rgba(148, 163, 184, 0.3)":"rgba(59, 130, 246, 0.3)"} 50%, \n            transparent 100%);\n        }\n        \n        .verified-badge {\n          display: flex;\n          align-items: center;\n          gap: 16px;\n          padding: 0;\n        }\n        \n        .badge-logo { \n          width: 48px; \n          height: 48px; \n          border-radius: 8px;\n          flex-shrink: 0;\n          transition: all 0.25s ease;\n        }\n        \n        .badge-logo:hover { \n          transform: scale(1.05); \n        }\n        \n        .badge-text {\n          font-size: 16px;\n          font-weight: 600;\n          color: ${"dark"===i?"#cbd5e1":"#475569"};\n          margin: 0;\n          line-height: 1.5;\n          letter-spacing: -0.01em;\n        }\n        \n        @media (max-width: 640px) {\n          .section { padding: 16px 20px; }\n          .badge-text { font-size: 14px; }\n          .badge-logo { width: 40px; height: 40px; }\n        }\n      `}),p="ar"===n?"تقييمات هذا المتجر تخضع للتدقيق بواسطة مشتري موثق":"This store's reviews are verified by Theqah Trusted Buyer",h=a("div",{class:"wrap"}),g=a("div",{class:"section"},[a("div",{class:"verified-badge"},[a("img",{class:"badge-logo",src:o,alt:"Theqah"}),a("p",{class:"badge-text"},p)])]);h.appendChild(g),l.appendChild(u),l.appendChild(h),e.setAttribute("data-state","done")}(c,n,String(i).toLowerCase(),String(s).toLowerCase()),mountedOnce=!0;else if(c&&"1"!==c.getAttribute("data-mounted")){const e=document.createElement("div");e.className="theqah-widget-empty",e.style.cssText="padding:12px;border:1px dashed #94a3b8;border-radius:12px;opacity:.8;font:13px system-ui;",e.textContent="ar"===String(i).toLowerCase()?"لم يتم العثور على معرف المتجر. تأكد من تثبيت التطبيق في متجر سلة.":"Store ID not found. Make sure the app is installed in your Salla store.",c.appendChild(e),c.setAttribute("data-mounted","1")}}else console.log("[Theqah] Not a product page - widget skipped")},l=()=>{try{c().catch(e=>console.warn("Widget mount failed:",e.message))}catch(e){console.warn("Widget initialization failed:",e.message)}finally{window.__THEQAH_LOADING__=!1}};if("loading"===document.readyState?document.addEventListener("DOMContentLoaded",l):setTimeout(l,100),!window.__THEQAH_OBS__&&"undefined"!=typeof MutationObserver){window.__THEQAH_OBS__=!0;const e=function(e){let t;return function(...n){clearTimeout(t),t=setTimeout(()=>e.apply(this,n),1e3)}}(()=>c()),t=new MutationObserver(t=>{t.some(e=>Array.from(e.addedNodes).some(e=>1===e.nodeType&&(e.classList?.contains("theqah-reviews")||e.querySelector?.(".theqah-reviews"))))&&e()});try{t.observe(document.body,{childList:!0,subtree:!0,attributes:!1,characterData:!1}),setTimeout(()=>{t.disconnect(),window.__THEQAH_OBS__=!1},3e4)}catch(e){console.warn("MutationObserver failed:",e)}}})();