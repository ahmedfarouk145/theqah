/* TheQah Widget - https://theqah.com */
(()=>{if(window.__THEQAH_LOADING__)return;window.__THEQAH_LOADING__=!0;const e=document.currentScript,t=(()=>{try{return new URL(e?.src||location.href).origin}catch{return location.origin}})(),r=`${t}/api/public/reviews`,o=`${t}/api/reviews/check-verified`,i=`${t}/widgets/logo.png?v=3`,n=window.__THEQAH__=window.__THEQAH__||{};function a(e){return`theqah:storeUid:${e}`}async function s(){const e=location.host.replace(/^www\./,"").toLowerCase();if(n.storeUid)return n.storeUid;const t=function(e){try{const t=JSON.parse(localStorage.getItem(a(e))||"{}");if(t.uid&&Date.now()-(t.t||0)<6e5)return t.uid}catch{}return null}(e);if(t)return n.storeUid=t,t;if(n.resolvePromise)return n.resolvePromise;const o=new AbortController,i=setTimeout(()=>o.abort(),5e3),s=`${r}/resolve?host=${encodeURIComponent(e)}&href=${encodeURIComponent(location.href)}&v=${encodeURIComponent("3.0.0")}`;return n.resolvePromise=fetch(s,{cache:"no-store",signal:o.signal}).then(e=>(clearTimeout(i),e.ok?e.json():null)).then(t=>{const r=t?.storeUid||null;return r&&(n.storeUid=r,function(e,t){try{localStorage.setItem(a(e),JSON.stringify({uid:t,t:Date.now()}))}catch{}}(e,r)),r}).catch(e=>(clearTimeout(i),console.warn("Store resolve failed:",e.message),null)).finally(()=>{n.resolvePromise=null}),n.resolvePromise}const c=async()=>{const t=document.querySelector("#theqah-reviews, .theqah-reviews");let r=t?.getAttribute?.("data-store")||t?.dataset?.store||e?.dataset?.store||"";const n=t?.getAttribute?.("data-lang")||t?.dataset?.lang||e?.dataset?.lang||("ar"===document.documentElement.lang?"ar":"en"),a=t?.getAttribute?.("data-theme")||t?.dataset?.theme||e?.dataset?.theme||"light";if(r&&(r.includes("{")||/STORE_ID/i.test(r)||"salla:"===r||!r.includes(":"))&&(console.log("[Theqah] Detected placeholder store:",r,"- attempting auto-resolve"),r=""),!r)try{const e=new Promise((e,t)=>setTimeout(()=>t(new Error("Resolve timeout")),5e3));r=await Promise.race([s(),e]),r&&console.log("[Theqah] Store resolved:",r)}catch(e){console.warn("[Theqah] Store resolution failed:",e.message),r=null}const c=t||function(){let e=document.querySelector("#theqah-reviews, .theqah-reviews");if(e)return e;const t=function(){const e=document.querySelector("[data-product-id], [data-productid]");if(e){const t=e.closest("section, .product, .product-page, .product__details, .product-single, .product-show");if(t)return t}const t=[".product-description",".product__description","#product-description",".product__details",".product-show",".product-single",".product-details",".product-info",".product-main","#product-show","#product","main .container"];for(const e of t){const t=document.querySelector(e);if(t)return t}return null}();return t?(e=document.createElement("div"),e.className="theqah-reviews",e.style.marginTop="24px",t&&t.parentNode&&t.parentNode.insertBefore(e,t.nextSibling),e):null}();c&&r&&(await async function(e,t){if("done"===e.getAttribute("data-state"))return;if("mounting"===e.getAttribute("data-state"))return;e.setAttribute("data-state","mounting");const r=function(){const e=document.querySelector("[data-product-id], [data-productid]");if(e){const t=e.getAttribute("data-product-id")||e.getAttribute("data-productid");if(t)return t}const t=location.pathname.match(/\/product\/(\d+)/);if(t)return t[1];const r=new URLSearchParams(location.search);return r.get("product_id")||r.get("productId")||null}(),n=await async function(e,t){try{const r=new URLSearchParams({storeId:e});t&&r.append("productId",t);const i=await fetch(`${o}?${r}`,{cache:"no-store",signal:AbortSignal.timeout(5e3)});return i.ok?await i.json():{hasVerified:!1,reviews:[]}}catch(e){return console.warn("Check verified failed:",e.message),{hasVerified:!1,reviews:[]}}}(t,r);if(n.hasVerified)return function(e){if(!e||0===e.length)return;const t=e.map(e=>String(e));["salla-comment-item",".s-comments-item",'[id^="s-comments-item-"]',"[data-review-id]",".product-review",".review-item",".s-review-item"].forEach(e=>{document.querySelectorAll(e).forEach(e=>{let r=null;if(r=e.getAttribute("data-review-id")||e.getAttribute("data-id"),!r){const t=e.querySelector('[id^="s-comments-item-"]');if(t){const e=t.id.match(/s-comments-item-(\d+)/);e&&(r=e[1])}}if(!r&&e.id){const t=e.id.match(/s-comments-item-(\d+)/);t&&(r=t[1])}if(r||(r=e.querySelector("[data-review-id]")?.getAttribute("data-review-id")),!r||!t.includes(String(r)))return;if(e.querySelector(".theqah-verified-logo"))return;let o=e.querySelector(".s-comments-item-user-info-name")||e.querySelector(".s-comments-item-user-wrapper")||e.querySelector(".review-header")||e.querySelector(".review-stars")||e.querySelector(".review-rating")||e.firstElementChild;if(!o)return;const n=document.createElement("img");n.src=i,n.className="theqah-verified-logo",n.alt="Verified by Theqah",n.title="مشتري موثق - Verified Buyer",n.style.cssText="width:24px;height:24px;margin:0 8px;display:inline-block;vertical-align:middle;border-radius:4px;",o.style.display="flex",o.style.alignItems="center",o.style.gap="8px",o.appendChild(n),console.log("[Theqah] Added verified badge to review:",r)})})}(n.reviews.map(e=>e.sallaReviewId)),void e.setAttribute("data-state","done");e.setAttribute("data-state","done"),e.style.display="none"}(c,r,String(n).toLowerCase(),String(a).toLowerCase()),mountedOnce=!0)},d=()=>{try{c().catch(e=>console.warn("Widget mount failed:",e.message))}catch(e){console.warn("Widget initialization failed:",e.message)}finally{window.__THEQAH_LOADING__=!1}};if("loading"===document.readyState?document.addEventListener("DOMContentLoaded",d):setTimeout(d,100),!window.__THEQAH_OBS__&&"undefined"!=typeof MutationObserver){window.__THEQAH_OBS__=!0;const e=function(e){let t;return function(...r){clearTimeout(t),t=setTimeout(()=>e.apply(this,r),1e3)}}(()=>c()),t=new MutationObserver(t=>{t.some(e=>Array.from(e.addedNodes).some(e=>1===e.nodeType&&(e.classList?.contains("theqah-reviews")||e.querySelector?.(".theqah-reviews"))))&&e()});try{t.observe(document.body,{childList:!0,subtree:!0,attributes:!1,characterData:!1}),setTimeout(()=>{t.disconnect(),window.__THEQAH_OBS__=!1},3e4)}catch(e){console.warn("MutationObserver failed:",e)}}})();