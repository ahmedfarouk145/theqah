name: Sync Salla Reviews (Daily Backup)

on:
  # DISABLED: Waiting for GitHub repo transfer to work account
  # Uncomment after adding CRON_SECRET to GitHub Secrets
  # schedule:
  #   # ÙŠØ´ØªØºÙ„ ÙƒÙ„ ÙŠÙˆÙ… Ø§Ù„Ø³Ø§Ø¹Ø© 3 ØµØ¨Ø§Ø­Ø§Ù‹ Ø¨ØªÙˆÙ‚ÙŠØª UTC (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©)
  #   - cron: '0 3 * * *'
  
  # ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„Ù‡ manual Ù…Ù† GitHub
  workflow_dispatch:

jobs:
  sync-reviews:
    runs-on: ubuntu-latest
    
    steps:
      - name: Sync Reviews (GitHub Backup)
        run: |
          echo "ğŸ”„ Starting GitHub backup sync..."
          
          response=$(curl -s -w "\n%{http_code}" \
            -X GET \
            -H "x-vercel-cron-secret: ${{ secrets.CRON_SECRET }}" \
            -H "User-Agent: GitHub-Actions-Backup-Cron" \
            https://theqah.com/api/cron/sync-salla-reviews)
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "ğŸ“Š Response Code: $http_code"
          echo "ğŸ“ Response Body: $body"
          
          if [ "$http_code" -eq 200 ]; then
            echo "âœ… Sync completed successfully"
          else
            echo "âŒ Sync failed with code $http_code"
            exit 1
          fi
      
      - name: Check System Health
        if: success()
        run: |
          echo "ğŸ¥ Checking system health..."
          
          response=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.ADMIN_SECRET }}" \
            https://theqah.com/api/admin/monitor-sync)
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "Health Status: $http_code"
          echo "$body" | jq '.summary, .quotaStatus' || echo "$body"
      
      - name: Send notification on failure
        if: failure()
        run: |
          echo "::error::âš ï¸ Salla reviews sync failed! Check logs and monitoring dashboard."
